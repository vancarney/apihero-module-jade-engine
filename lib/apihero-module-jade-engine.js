// Generated by CoffeeScript 1.9.3
var TemplateManager, _, browserify, fs, path, router;

_ = require('lodash')._;

fs = require('fs-extra');

path = require('path');

router = require('apihero-module-jade-router');

browserify = require('apihero-module-browserify');

module.exports.browserify = browserify;

module.exports.jade = {};

_.each(router['jade'], (function(_this) {
  return function(fun, param) {
    return module.exports.jade[param] = fun;
  };
})(this));

module.exports.router = router;

module.exports.init = function(app, options, callback) {
  var defaults, tMan;
  defaults = {
    distDir: path.join(app_root || process.cwd(), 'dist'),
    buildDir: path.join(app_root || process.cwd(), 'build'),
    fileName: 'templates.js',
    templateDirectives: {}
  };
  this.options = _.extend({}, defaults, options);
  router.init(app, options, (function(_this) {
    return function() {
      return callback.apply(_this, arguments);
    };
  })(this));
  tMan = new TemplateManager;
  return app.once('ahero-modules-loaded', (function(_this) {
    return function() {
      var out, outFile;
      out = "var jade = require('" + (path.join(__dirname, '..', 'node_modules', 'jade-runtime')) + "')";
      _.each((_this.configs = app.ApiHero.getModuleConfigs()), function(config) {
        return out += tMan.processConfig(config);
      });
      outFile = path.join(_this.options.buildDir, _this.options.fileName);
      return fs.outputFile(outFile, out, function(e) {
        try {
          browserify.browserify(outFile).bundle().pipe(fs.createWriteStream(_this.options.distDir));
        } catch (_error) {
          e = _error;
          console.log(e);
          return callback("unable to create template client");
        }
        return callback(e != null ? e : null);
      });
    };
  })(this));
};

TemplateManager = require('./TemplateManager');
